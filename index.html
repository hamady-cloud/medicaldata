<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医療データ可視化 (Medical Data Visualization)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data.js"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-sm z-10 sticky top-0">
        <div class="max-w-7xl mx-auto px-4 py-2 md:py-4 flex justify-between items-center">
            <h1 class="text-lg md:text-2xl font-bold text-blue-600 tracking-tight flex items-center gap-2">
                <svg class="w-6 h-6 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                    </path>
                </svg>
                <span class="hidden md:inline">医療需給可視化マップ (都道府県別)</span>
                <span class="md:hidden">医療需給マップ</span>
            </h1>
            <div class="flex items-center space-x-1 bg-blue-50 px-3 py-1 rounded-full">
                <span class="text-xs md:text-sm font-bold text-blue-800">Year:</span>
                <span id="yearLabel" class="text-lg md:text-xl font-bold text-blue-600 tabular-nums">2024</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col p-4 max-w-7xl mx-auto w-full space-y-6">

        <!-- Controls -->
        <!-- Controls -->
        <!-- Mobile Toggle Button -->
        <div class="md:hidden mb-4">
            <button id="toggleControlsBtn"
                class="w-full bg-white p-3 rounded-lg shadow-sm border border-gray-200 text-blue-600 font-bold flex justify-center items-center gap-2 transition-colors hover:bg-gray-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                </svg>
                <span>検索・設定 (Filter / Settings)</span>
            </button>
        </div>

        <div id="controlsPanel"
            class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-gray-100 hidden md:grid grid-cols-1 md:grid-cols-3 gap-6 items-end">

            <!-- Metric Selector -->
            <div class="flex flex-col space-y-1">
                <label for="metricSelect" class="text-xs font-bold text-gray-400 uppercase tracking-wider">Y軸
                    (Y-Axis)</label>
                <div class="relative">
                    <select id="metricSelect"
                        class="w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 outline-none appearance-none cursor-pointer">
                        <option value="doctors">医師数</option>
                        <option value="hospitals">病院数</option>
                        <option value="beds">病床数 (全体)</option>
                        <option value="bedsPsych">病床数 (精神)</option>
                        <option value="bedsCare">病床数 (療養)</option>
                        <option value="bedsGeneral">病床数 (一般)</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Prefecture Filter -->
            <div class="flex flex-col space-y-1">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">都道府県絞り込み (Filter)</label>
                <div class="relative">
                    <select id="prefFilter"
                        class="w-full bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 outline-none appearance-none cursor-pointer">
                        <option value="all">全て表示 (All Prefectures)</option>
                        <!-- Options will be populated by JS -->
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Year Slider -->
            <div class="flex flex-col space-y-1">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">年度選択 (Year): <span
                        id="sliderValue" class="text-blue-600">2024</span></label>
                <input id="yearSlider" type="range" min="2014" max="2024" step="2" value="2024"
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                <div class="flex justify-between text-xs text-gray-400 px-1">
                    <span>2014</span>
                    <span>2024</span>
                </div>
            </div>
        </div>

        <!-- Chart Container -->
        <!-- Chart Container -->
        <div
            class="bg-white p-2 md:p-4 rounded-xl shadow-lg border border-gray-100 relative min-h-[350px] md:min-h-[500px]">
            <canvas id="scatterChart"></canvas>
            <div class="absolute top-2 right-4 text-xs text-gray-400">
                <span
                    class="inline-block w-3 h-0.5 bg-gray-400 align-middle mr-1 border-t border-dashed border-gray-400"></span>
                平均値 (Average)
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h2 class="text-lg font-bold text-gray-800">データ一覧 (Data Table)</h2>
            </div>
            <div class="overflow-x-auto max-h-[500px]">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th scope="col"
                                class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                都道府県 <span class="hidden md:inline">(Prefecture)</span></th>
                            <th scope="col"
                                class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Y値 (<span id="tableYLabel">Doctors</span>)</th>
                            <th scope="col"
                                class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                X値 <span class="hidden md:inline">(高齢化率 Aging Rate)</span><span
                                    class="md:hidden">(高齢化率)</span></th>
                            <th scope="col"
                                class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                総人口 <span class="hidden md:inline">(Total Pop)</span></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Rows populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Footer: Site Purpose and Significance -->
    <footer class="bg-gray-100 border-t border-gray-200 mt-12 py-12 px-4">
        <div class="max-w-7xl mx-auto">
            <div class="mb-10 text-center">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">MedicalData</h2>
                <p class="text-gray-600">医療供給（医師・病院・病床）と高齢化を、年度×地域（都道府県／二次医療圏）で比較できるデータビューア</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- 1. Why -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="flex items-center gap-2 text-lg font-bold text-blue-600 mb-4">
                        <span class="flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-600 rounded-full text-sm">1</span>
                        課題 (Why)
                    </h3>
                    <p class="text-sm text-gray-700 leading-relaxed mb-4">
                        医療提供体制の議論では「医師が足りない」「病床が多い／少ない」といった話が出る一方で、実務ではどの年の・どの指標を・どの地域単位で見ているかが揃わず、比較が曖昧になりがちです。
                    </p>
                    <p class="text-sm text-gray-700 leading-relaxed">
                        本ツールは、医療供給と需要側の背景（高齢化）を同一UIで年度横断・地域比較できる形に整理し、議論の前提を揃えることを目的としています。
                    </p>
                </div>

                <!-- 2. So what -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="flex items-center gap-2 text-lg font-bold text-blue-600 mb-4">
                        <span class="flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-600 rounded-full text-sm">2</span>
                        意思決定 (So what)
                    </h3>
                    <ul class="space-y-3 text-sm text-gray-700">
                        <li class="flex gap-2">
                            <span class="font-bold text-gray-900 shrink-0">行政・医療計画:</span>
                            <span>都道府県／二次医療圏の相対比較、年次推移の確認、論点の切り出し</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="font-bold text-gray-900 shrink-0">調査・コンサル:</span>
                            <span>初期診断（現状把握）→追加調査（人口当たり、医療圏内偏在、アクセス等）の論点設計</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="font-bold text-gray-900 shrink-0">企画・研究:</span>
                            <span>医療供給の変化と高齢化の進行を同じ軸で眺め、仮説を作る</span>
                        </li>
                    </ul>
                </div>

                <!-- 3. What -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="flex items-center gap-2 text-lg font-bold text-blue-600 mb-4">
                        <span class="flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-600 rounded-full text-sm">3</span>
                        論点と仮説 (What)
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="text-sm font-bold text-gray-900">論点A：年度による変化</h4>
                            <p class="text-xs text-gray-600">2014 / 2016 / 2018 / 2020 / 2022 / 2024 で、医師・病院・病床がどう変化しているか</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-900">論点B：地域間の偏り</h4>
                            <p class="text-xs text-gray-600">同じ年・同じ指標で、都道府県／二次医療圏間の差はどれくらいか</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-900">論点C：需要側の背景（高齢化）との併読</h4>
                            <p class="text-xs text-gray-600">供給側の差を読むときに、高齢化率を併せて見て誤読を減らせるか</p>
                        </div>
                        <div class="pt-2 border-t border-dashed border-gray-200">
                            <h4 class="text-sm font-bold text-blue-500">拡張仮説 (TODO)</h4>
                            <p class="text-xs text-gray-600 italic">実数だけでなく、人口10万人あたり等に正規化すると“供給力”比較がさらに明確になる</p>
                        </div>
                    </div>
                </div>

                <!-- 4. Features -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="flex items-center gap-2 text-lg font-bold text-blue-600 mb-4">
                        <span class="flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-600 rounded-full text-sm">4</span>
                        現状の到達点 (Features)
                    </h3>
                    <ul class="grid grid-cols-2 gap-2 text-sm text-gray-700">
                        <li class="flex items-center gap-1">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>
                            年度切替
                        </li>
                        <li class="flex items-center gap-1">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>
                            指標切替
                        </li>
                        <li class="flex items-center gap-1">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>
                            都道府県フィルタ
                        </li>
                        <li class="flex items-center gap-1">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>
                            データ一覧表示
                        </li>
                        <li class="flex items-center gap-1 col-span-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>
                            指標定義を明示
                        </li>
                    </ul>
                </div>

                <!-- 5. Evidence -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 lg:col-span-2">
                    <h3 class="flex items-center gap-2 text-lg font-bold text-blue-600 mb-4">
                        <span class="flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-600 rounded-full text-sm">5</span>
                        データと定義 (Evidence)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-sm font-bold text-gray-900 border-l-4 border-blue-500 pl-2 mb-2">指標定義 (Definitions)</h4>
                            <ul class="text-xs text-gray-700 space-y-1 font-mono">
                                <li>高齢化率: agingRate = elderlyPop / totalPop * 100</li>
                                <li>doctors: 医師数</li>
                                <li>hospitals: 病院数</li>
                                <li>beds: 病床数（全体）</li>
                                <li>bedsPsych: 病床数（精神）</li>
                                <li>bedsCare: 病床数（療養）</li>
                                <li>bedsGeneral: 病床数（一般）</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-900 border-l-4 border-blue-500 pl-2 mb-2">出典 (Sources)</h4>
                            <p class="text-xs text-gray-600 mb-2">
                                <span class="font-bold">人口・高齢者数:</span> 「住民基本台帳に基づく人口、人口動態及び世帯数調査」（総務省）
                            </p>
                            <p class="text-xs text-gray-600 mb-2">
                                <span class="font-bold">医療供給:</span> 「医師・歯科医師・薬剤師統計」（厚生労働省）
                            </p>
                            <p class="text-[10px] text-gray-400 mt-2 bg-gray-50 p-2 rounded border border-gray-100 italic">
                                ※人口系と医療供給系で原典が異なるため、年次の定義（基準日）や集計範囲の差が出る可能性があります。相対比較を基本とし、厳密比較が必要な場合は原典を確認してください。
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 6. Findings -->
                <div class="bg-blue-50 p-6 rounded-xl shadow-sm border border-blue-100 lg:col-span-3">
                    <h3 class="flex items-center gap-2 text-lg font-bold text-blue-700 mb-4">
                        <span class="flex items-center justify-center w-6 h-6 bg-blue-200 text-blue-700 rounded-full text-sm">6</span>
                        結果 (Findings：発見トップ3)
                    </h3>
                    <div class="bg-white p-4 rounded-lg border border-blue-100">
                        <p class="text-sm text-gray-700 leading-relaxed">
                            （例：和歌山県・二次医療圏）和歌山県内の二次医療圏で医師数（実数）を比較すると、<span class="font-bold text-blue-700">和歌山医療圏：1,808人（高齢化率32.11%、総人口411,542）</span>が最大で、次いで 田辺：305人、那賀：236人、橋本：219人、御坊：161人、新宮：144人、<span class="font-bold text-red-600">有田：125人（34.92%、68,622）</span>となる。
                        </p>
                        <p class="text-sm text-gray-700 leading-relaxed mt-3">
                            このように、同じ県内でも二次医療圏によって <span class="font-bold underline decoration-blue-500">医師数（供給の実数）</span> と <span class="font-bold underline decoration-orange-500">高齢化率（背景）</span> が同時に変動するため、片方だけを見ると誤読しやすい。特に新宮は高齢化率が高く（43.04%）、人口構成を踏まえた見立てが必要である。
                        </p>
                    </div>
                </div>

                <!-- 7. Implications -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="flex items-center gap-2 text-lg font-bold text-blue-600 mb-4">
                        <span class="flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-600 rounded-full text-sm">7</span>
                        示唆 (Implications)
                    </h3>
                    <div class="space-y-4">
                        <div class="flex gap-3">
                            <div class="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded h-fit">優先度A</div>
                            <div class="text-sm text-gray-700">実数比較で当たりを付け、次に正規化へ進む。人口10万人あたりの指標追加でさらなる比較が可能。</div>
                        </div>
                        <div class="flex gap-3">
                            <div class="text-xs font-bold text-orange-500 bg-orange-50 px-2 py-1 rounded h-fit">優先度B</div>
                            <div class="text-sm text-gray-700">高齢化率を併読して論点を分ける。高齢化圏域はアクセス・連携等の論点を整理。</div>
                        </div>
                        <div class="flex gap-3">
                            <div class="text-xs font-bold text-yellow-500 bg-yellow-50 px-2 py-1 rounded h-fit">優先度C</div>
                            <div class="text-sm text-gray-700">差が大きい圏域を抽出し、追加調査（施設分布、アクセス、流動等）へ接続する。</div>
                        </div>
                    </div>
                </div>

                <!-- 8. How -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 lg:col-span-2">
                    <h3 class="flex items-center gap-2 text-lg font-bold text-blue-600 mb-4">
                        <span class="flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-600 rounded-full text-sm">8</span>
                        再現性 (How)
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <p class="text-xs text-gray-400 mb-1 uppercase tracking-wider">Demo</p>
                            <a href="https://hamady-cloud.github.io/medicaldata/" class="text-blue-600 hover:underline text-sm break-all font-mono">https://hamady-cloud.github.io/medicaldata/</a>
                            <p class="text-xs text-gray-700 mt-4 leading-relaxed">
                                <span class="font-bold text-gray-900">使い方:</span> 年度・指標・都道府県・地域単位を切り替えて確認。
                            </p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 mb-1 uppercase tracking-wider">データ更新 (Workflow)</p>
                            <ol class="text-xs text-gray-600 space-y-1 list-decimal list-inside font-mono">
                                <li>YYYY.csv を追加／更新</li>
                                <li>convert_data.ps1 を実行</li>
                                <li>data.js をコミットして更新</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-12 pt-8 border-t border-gray-200 text-center text-gray-400 text-xs">
                &copy; 2024-2026 MedicalData Project. Created with focus on healthcare supply-demand analysis.
            </div>
        </div>
    </footer>

    <script>
        const chartCtx = document.getElementById('scatterChart').getContext('2d');
        let currentYear = "2024";
        let currentMetric = "doctors";
        let currentFilter = "all"; // 'all' or prefCode

        let chartInstance = null;
        let globalAvgX = 0;
        let globalAvgY = 0;

        const metricLabels = {
            doctors: "医師数",
            hospitals: "病院数",
            beds: "病床数 (全体)",
            bedsPsych: "病床数 (精神)",
            bedsCare: "病床数 (療養)",
            bedsGeneral: "病床数 (一般)"
        };

        const prefNames = {
            "01": "北海道", "02": "青森県", "03": "岩手県", "04": "宮城県", "05": "秋田県",
            "06": "山形県", "07": "福島県", "08": "茨城県", "09": "栃木県", "10": "群馬県",
            "11": "埼玉県", "12": "千葉県", "13": "東京都", "14": "神奈川県", "15": "新潟県",
            "16": "富山県", "17": "石川県", "18": "福井県", "19": "山梨県", "20": "長野県",
            "21": "岐阜県", "22": "静岡県", "23": "愛知県", "24": "三重県", "25": "滋賀県",
            "26": "京都府", "27": "大阪府", "28": "兵庫県", "29": "奈良県", "30": "和歌山県",
            "31": "鳥取県", "32": "島根県", "33": "岡山県", "34": "広島県", "35": "山口県",
            "36": "徳島県", "37": "香川県", "38": "愛媛県", "39": "高知県", "40": "福岡県",
            "41": "佐賀県", "42": "長崎県", "43": "熊本県", "44": "大分県", "45": "宮崎県",
            "46": "鹿児島県", "47": "沖縄県"
        };

        // Plugin to draw quadrants
        const quadrantsPlugin = {
            id: 'quadrants',
            afterDatasetsDraw(chart, args, options) {
                const { ctx, chartArea: { top, bottom, left, right }, scales: { x, y } } = chart;

                // If global averages valid
                if (globalAvgX === 0 && globalAvgY === 0) return;

                const xVal = x.getPixelForValue(globalAvgX);
                const yVal = y.getPixelForValue(globalAvgY);

                ctx.save();
                ctx.beginPath();
                ctx.lineWidth = 1;
                ctx.strokeStyle = 'rgba(107, 114, 128, 0.4)'; // gray-500, light
                ctx.setLineDash([6, 6]);

                // Vertical Line (Avg X)
                if (xVal >= left && xVal <= right) {
                    ctx.moveTo(xVal, top);
                    ctx.lineTo(xVal, bottom);
                }

                // Horizontal Line (Avg Y)
                if (yVal >= top && yVal <= bottom) {
                    ctx.moveTo(left, yVal);
                    ctx.lineTo(right, yVal);
                }

                ctx.stroke();

                // Add Labels
                const fontSize = 12;
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.fillStyle = 'rgba(107, 114, 128, 0.8)';
                ctx.textAlign = 'left';

                if (xVal > left + 100) { // Left-side labels (High Y)
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'top';
                    ctx.fillText('供給過多 (Supply Excess)', left + 10, top + 10);
                }

                if (xVal < right - 100) { // Right-side labels (Low Y)
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'bottom';
                    ctx.fillText('需要過多 (Demand Excess)', right - 10, bottom - 10);
                }

                ctx.restore();
            }
        };

        // Get Raw Secondary Area Data for all areas
        function getSecondaryAreaData(year, metric) {
            if (typeof medicalData === 'undefined' || !medicalData[year]) return [];
            return medicalData[year].map(d => {
                const codeStr = String(d.id).padStart(4, '0');
                return {
                    x: d.agingRate,
                    y: d[metric],
                    name: d.area,
                    code: codeStr.substring(0, 2), // Pref code
                    id: d.id,
                    totalPop: d.totalPop
                };
            });
        }

        // Get Aggregated Prefecture Data
        function getPrefectureData(year, metric) {
            if (typeof medicalData === 'undefined' || !medicalData[year]) return [];

            const rawData = medicalData[year];
            const prefMap = {};

            rawData.forEach(d => {
                const codeStr = String(d.id).padStart(4, '0');
                const prefCode = codeStr.substring(0, 2);

                if (!prefMap[prefCode]) {
                    prefMap[prefCode] = {
                        code: prefCode,
                        metricSum: 0,
                        elderlySum: 0,
                        totalPopSum: 0,
                    };
                }
                prefMap[prefCode].metricSum += d[metric];
                prefMap[prefCode].elderlySum += d.elderlyPop;
                prefMap[prefCode].totalPopSum += d.totalPop;
            });

            return Object.values(prefMap).map(p => ({
                x: (p.totalPopSum > 0 ? (p.elderlySum / p.totalPopSum) * 100 : 0),
                y: p.metricSum,
                name: prefNames[p.code] || `都道府県 ${p.code}`,
                code: p.code,
                totalPop: p.totalPopSum
            }));
        }

        function populatePrefSelect() {
            const select = document.getElementById('prefFilter');
            select.innerHTML = '<option value="all">全て表示 (All Prefectures)</option>';
            Object.keys(prefNames).sort().forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.innerText = prefNames[code];
                select.appendChild(opt);
            });
        }

        function initChart() {
            populatePrefSelect();

            Chart.register(quadrantsPlugin);

            chartInstance = new Chart(chartCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Data',
                        data: [],
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(220, 38, 38, 1)',
                        borderWidth: 1,
                        pointRadius: 6,
                        pointHoverRadius: 9
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.9)',
                            padding: 12,
                            callbacks: {
                                label: function (context) {
                                    return context.raw.name;
                                },
                                afterLabel: function (context) {
                                    const p = context.raw;
                                    return `X(高齢化率): ${p.x.toFixed(1)}% | Y: ${p.y.toLocaleString()}`;
                                }
                            }
                        },
                        legend: { display: false },
                        title: {
                            display: true,
                            text: '',
                            font: { size: 18, weight: 'bold' },
                            color: '#1f2937'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: '高齢化率 (Aging Rate %)', font: { weight: 'bold' } },
                            grid: { color: '#f3f4f6' },
                            min: 0,
                            max: 55
                        },
                        y: {
                            title: { display: true, text: '', font: { weight: 'bold' } },
                            grid: { color: '#f3f4f6' },
                            beginAtZero: true
                        }
                    },
                    animation: {
                        duration: 600,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        function updateChart() {
            let displayData = [];
            let chartTitle = "";
            let pointColor = "";
            let borderColor = "";

            if (currentFilter === 'all') {
                // Show Prefectures Aggregated
                displayData = getPrefectureData(currentYear, currentMetric);
                chartTitle = `都道府県別: ${metricLabels[currentMetric]} vs 高齢化率 (${currentYear})`;
                pointColor = 'rgba(239, 68, 68, 0.7)'; // Red
                borderColor = 'rgba(220, 38, 38, 1)';
            } else {
                // Show Secondary Areas for specific Prefecture
                const allAreas = getSecondaryAreaData(currentYear, currentMetric);
                displayData = allAreas.filter(d => d.code === currentFilter);

                const prefName = prefNames[currentFilter] || currentFilter;
                chartTitle = `${prefName}内の二次医療圏: ${metricLabels[currentMetric]} vs 高齢化率 (${currentYear})`;
                pointColor = 'rgba(59, 130, 246, 0.7)'; // Blue
                borderColor = 'rgba(37, 99, 235, 1)';
            }

            // Calculate Global Averages for currently displayed data
            if (displayData.length > 0) {
                const sumX = displayData.reduce((acc, d) => acc + d.x, 0);
                const sumY = displayData.reduce((acc, d) => acc + d.y, 0);
                globalAvgX = sumX / displayData.length;
                globalAvgY = sumY / displayData.length;
            } else {
                globalAvgX = 0; globalAvgY = 0;
            }

            chartInstance.data.datasets[0].data = displayData;
            chartInstance.data.datasets[0].backgroundColor = pointColor;
            chartInstance.data.datasets[0].borderColor = borderColor;

            chartInstance.options.plugins.title.text = chartTitle;
            chartInstance.options.scales.y.title.text = metricLabels[currentMetric];

            chartInstance.update();

            document.getElementById('yearLabel').textContent = currentYear;
            document.getElementById('sliderValue').textContent = currentYear;
            document.getElementById('tableYLabel').innerText = metricLabels[currentMetric];

            // Update Table
            updateTable(displayData);
        }

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            // Sort by Y descending (Metric Value)
            const sorted = [...data].sort((a, b) => b.y - a.y);

            sorted.forEach(d => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-xs md:text-sm font-medium text-gray-900">${d.name}</td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-500 text-right font-mono">${d.y.toLocaleString()}</td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-500 text-right font-mono">${d.x.toFixed(2)}%</td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-xs md:text-sm text-gray-500 text-right font-mono">${d.totalPop.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Init
        window.addEventListener('load', () => {
            initChart();
            updateChart();
        });

        // Listeners
        document.getElementById('yearSlider').addEventListener('input', (e) => {
            currentYear = e.target.value;
            updateChart();
        });

        document.getElementById('metricSelect').addEventListener('change', (e) => {
            currentMetric = e.target.value;
            updateChart();
        });

        document.getElementById('prefFilter').addEventListener('change', (e) => {
            currentFilter = e.target.value;
            updateChart();
        });

        // Toggle Controls for Mobile
        const toggleBtn = document.getElementById('toggleControlsBtn');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                const panel = document.getElementById('controlsPanel');
                if (panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                    panel.classList.add('grid');
                } else {
                    panel.classList.add('hidden');
                    panel.classList.remove('grid');
                }
            });
        }

    </script>
</body>

</html>